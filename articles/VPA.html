<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1d. Virtual population analysis (VPA) • SAMtool</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1d. Virtual population analysis (VPA)">
<meta property="og:description" content="SAMtool">
<meta property="og:image" content="https://SAMtool.openMSE.com/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SAMtool</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SAMtool.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Delay_difference.html">1a. Delay-difference and delay-differential models</a>
    </li>
    <li>
      <a href="../articles/RCM.html">2. Description of the RCM (Rapid Conditioning Model) for conditioning MSEtool operating models</a>
    </li>
    <li>
      <a href="../articles/RCM_eq.html">2a. Mathematical description of the RCM</a>
    </li>
    <li>
      <a href="../articles/RCM_sel.html">2b. Configuring selectivity for the RCM</a>
    </li>
    <li>
      <a href="../articles/SCA.html">1b. Statistical catch-at-age (SCA) model</a>
    </li>
    <li>
      <a href="../articles/Surplus_production.html">1c. Surplus production model</a>
    </li>
    <li>
      <a href="../articles/VPA.html">1d. Virtual population analysis (VPA)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Blue-Matter/SAMtool/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="VPA_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1d. Virtual population analysis (VPA)</h1>
                        <h4 class="author">Quang Huynh (<a href="mailto:quang@bluematterscience.com" class="email">quang@bluematterscience.com</a>)</h4>
            
            <h4 class="date">2021-05-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Blue-Matter/SAMtool/blob/master/vignettes/VPA.Rmd"><code>vignettes/VPA.Rmd</code></a></small>
      <div class="hidden name"><code>VPA.Rmd</code></div>

    </div>

    
    
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "all"} } });
</script><style type="text/css">

body{ /* Normal  */
   font-size: 12px;
}
td {  /* Table  */
   font-size: 8px;
}
h1 { /* Header 1 */
 font-size: 18px;
 color: DarkBlue;
}
h2 { /* Header 2 */
 font-size: 15px;
 color: DarkBlue;
}
h3 { /* Header 3 */
 font-size: 14px;
 color: DarkBlue;
}
code.r{ /* Code block */
  font-size: 10px;
}
pre { /* Code block */
  font-size: 10px
}
</style>
<p><br></p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In SAMtool, assessment models are of class <code>Assess</code>. This appendix provides a brief description and references for the <code>Assess</code> objects. Further details regarding parameterization, e.g., fixing parameters, and tuning, e.g., adjusting start parameters, are provided in the function documentation.</p>
<p>For LaTeX equation rendering, it is recommended that this vignette be viewed in a HTML browser. This can be done with the <code>browseVignettes</code> function in R:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/browseVignettes.html">browseVignettes</a></span><span class="op">(</span><span class="st">"SAMtool"</span><span class="op">)</span></code></pre></div>
</div>
<div id="virtual-population-analysis-vpa" class="section level1">
<h1 class="hasAnchor">
<a href="#virtual-population-analysis-vpa" class="anchor"></a>Virtual Population Analysis (VPA)</h1>
<p>The VPA model reconstructs the historical population based on an expanded catch at age matrix and an index of abundance. From an estimate of the fishing mortality in the terminal year, historical abundance and fishing mortality are back-calculated. Natural mortality is a required input parameter. For a biomass-based index, weight at age is also required. Maturity at age is also required if spawning biomass is to be calculated. The dynamics equations are based on VPA-2BOX (Porch 2018), although 2-stock mixing and diffusion processes are not modeled here. The maximum age in the model is a plus-group accumulator age.</p>
<div id="dynamics-equations" class="section level2">
<h2 class="hasAnchor">
<a href="#dynamics-equations" class="anchor"></a>Dynamics equations</h2>
<p>In this model, fishing mortality <span class="math inline">\(F_{a,t}\)</span> of age <span class="math inline">\(a\)</span> in year <span class="math inline">\(t\)</span> is generally solved from the observed catch of the corresponding age and year <span class="math inline">\(C_{a,t}\)</span> and the estimated abundance of the same cohort in the following year <span class="math inline">\(N_{a+1,t+1}\)</span>: <span class="math display">\[F_{a,t} = \dfrac{Z_{a,t}C_{a,t}}{[\exp(Z_{a,t}) - 1]N_{a+1,t+1}},\]</span> where <span class="math inline">\(Z_{a,t} = F_{a,t} + M_a\)</span>, and <span class="math inline">\(M\)</span> is natural mortality. Equation 1 is Baranov’s equation with the substitution: <span class="math inline">\(N_{a,t}=N_{a+1,t+1}\exp(Z_{a,t})\)</span>. Newton’s method is used to numerically solve Equation 1.</p>
<p>With <span class="math inline">\(F_{a,t}\)</span>, the abundance of the corresponding age and year is solved also from Baranov’s equation: <span class="math display">\[N_{a,t} = \dfrac{C_{a,t}Z_{a,t}}{F_{a,t}[1 - \exp(-Z_{a,t})]}.\]</span></p>
<p>There are two exceptions to this algorithm. First, for the terminal year <span class="math inline">\(t=T\)</span>, F is estimated in the model, followed by the calculations for the terminal year abundances with Equation 2. This starts the back-calculations for <span class="math inline">\(F\)</span> and <span class="math inline">\(N\)</span> for the preceding years with equations 1 and 2, respectively. The terminal F-at-age vector <span class="math inline">\(F_{a,T}\)</span> can be free parameters with age or constrained as a logistic or double-normal (dome) function with age.</p>
<p>Second, the fishing mortality rates of the plus-group age <span class="math inline">\(a=A\)</span> and the preceding age <span class="math inline">\(a=A-1\)</span> are subject to additional constraints and are solved separately. First, note that the abundance of the plus-group in year <span class="math inline">\(t+1\)</span> must satisfy the equation <span class="math display">\[ N_{A,t+1} = N_{A,t}\exp(-Z_{A,t}) + N_{A-1,t}\exp(-Z_{A-1,t}),\]</span> with <span class="math display">\[\begin{align}
N_{A,t} &amp;= \dfrac{C_{A,t}Z_{A,t}}{F_{A,t}[1 - \exp(-Z_{A,t})]}\\
N_{A-1,t} &amp;= \dfrac{C_{A-1,t}Z_{A-1,t}}{F_{A-1,t}[1 - \exp(-Z_{A-1,t})]}
\end{align}.\]</span></p>
<p>An additional constraint is needed for the plus-group <span class="math inline">\(F\)</span>, where <span class="math display">\[F_{A,t} = \alpha F_{A-1,t},\]</span> where <span class="math inline">\(\alpha\)</span> is a numeric constant either fixed (often to 1) or estimated in the model.</p>
<p>From <span class="math inline">\(N_{A,t+1}\)</span>, <span class="math inline">\(C_{A,t}\)</span>, <span class="math inline">\(C_{A-1,t}\)</span>, <span class="math inline">\(M_A\)</span>, and <span class="math inline">\(M_{A-1}\)</span>, we can solve <span class="math inline">\(F_{A-1,t}\)</span> and <span class="math inline">\(F_{A,t}\)</span> as the values that satisfy equations 3-6. The corresponding abundances <span class="math inline">\(N_{A-1,t}\)</span> and <span class="math inline">\(N_{A,t}\)</span> are then obtained with equation 2.</p>
<p>The VPA is tuned to an index via maximum likelihood. The predicted biomass index is <span class="math display">\[ \hat{I}_t = \hat{q}\sum_a N_{a,t} w_a.\]</span> The likelihood of the observed index is</p>
<p><span class="math display">\[L^I = \sum_t \left(-\log(\sigma) - 0.5\left[\dfrac{\log(I_t) - \log(\hat{I}_t)}{\sigma}\right]^2\right),\]</span></p>
<p><span class="math display">\[\log(I_t) \sim N(\log(\hat{I}_t), \sigma^2).\]</span></p>
<p>From the VPA output, reference points can be calculated. Estimates of recruitment (the youngest age class <span class="math inline">\(\tilde{a}\)</span>) and spawning biomass are used to estimate a stock-recruitment relationship to obtain MSY and unfished reference points.</p>
</div>
<div id="additional-constraints" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-constraints" class="anchor"></a>Additional constraints</h2>
<p>In any VPA model, estimates of F and N of the youngest age classes are highly uncertain. To stabilize estimates, random walk penalties can be applied to the recruitment and vulnerability estimates in the most recent years: <span class="math display">\[ \begin{align}
\log(N_{\tilde{a},t}) &amp;\sim N(\log(N_{\tilde{a}, t-1}), \sigma_{\tilde{a}}^2)\\
\log(v_{a,t}) &amp;\sim N(\log(v_{a,t-1}, \sigma_v^2)
\end{align},\]</span> where <span class="math inline">\(\tilde{a}\)</span> is the smallest age in the VPA and <span class="math inline">\(v_{a,t} = F_{a,t}/\max_a F_{a,t}\)</span>.</p>
<p>Note that these penalties can significantly alter model results, and generate spurious trends in F and N especially if there are significantly shifts in recent vulnerability and recruitment. The implications of incorporating these random walk penalties need to be evaluated on a case-by-case basis.</p>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Porch, C.E. 2018. VPA-2BOX 4.01 User Guide. NOAA Tech. Memo. NMFS-SEFSC-726. 67 pp.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Quang Huynh, Tom Carruthers, Adrian Hordyk.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
